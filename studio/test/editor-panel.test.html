<!doctype html>
<html>
    <head>
        <script type="module">
            window.process = { env: {} };
            window.__swc = { warn: () => {} };

            // Set up fetch mock before any components are loaded
            const originalFetch = window.fetch;
            window.fetch = async function (args) {
                try {
                    const url = new URL(args);
                    const { pathname, search } = url;
                    const fullPath = pathname + search;

                    if (/querybuilder\.json\?path=\/content\/cq:tags\/mas/.test(fullPath)) {
                        return originalFetch('/test/mocks/tags.json');
                    }
                    if (/querybuilder\.json\?path=\/content\/dam\/mas/.test(fullPath)) {
                        return originalFetch('/test/mocks/folders.json');
                    }
                    return originalFetch(...arguments);
                } catch (e) {
                    // If URL construction fails, just pass through to original fetch
                    return originalFetch(...arguments);
                }
            };
        </script>
        <title>editor-panel custom element test page</title>
        <meta name="nofollow-links" content="on" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="../style.css" />
        <style>
            body {
                margin: 32px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            sp-theme {
                display: contents;
            }

            editor-panel {
                width: 600px;
                top: 32px;
                bottom: 32px;
                height: initial;
            }
        </style>
    </head>
    <body>
        <script type="module">
            import { runTests } from '@web/test-runner-mocha';
            import { expect } from '@esm-bundle/chai';
            import sinon from 'sinon';
            import { html } from 'lit';
            import { fixture, oneEvent } from '@open-wc/testing-helpers';
            import '../src/swc.js';
            import '../src/rte/rte-field.js';
            import '../src/aem/aem-tag-picker-field.js';
            import '../src/editor-panel.js';
            import '../src/editors/merch-card-collection-editor.js';
            import '../src/editors/version-panel.js';
            import '../src/mas-repository.js';
            import { Fragment } from '../src/aem/fragment.js';
            import { FragmentStore } from '../src/reactivity/fragment-store.js';
            import Store from '../src/store.js';
            import { createFromTemplate, delay, triggerInput, triggerRteInput } from './utils.js';

            runTests(async () => {
                const spTheme = document.querySelector('sp-theme');

                const fragmentData = await fetch('/test/mocks/adobe/sites/cf/fragments/collection.json').then((res) =>
                    res.json(),
                );

                describe('editor-panel custom element', () => {
                    let fragment;
                    let fragmentStore;
                    let editorPanel;
                    beforeEach(async () => {
                        // Create a collection fragment with a valid UUID
                        const mockFragment = {
                            ...fragmentData,
                            id: '12345678-1234-1234-1234-123456789012',
                        };
                        fragment = new Fragment(mockFragment);
                        fragmentStore = new FragmentStore(fragment);
                        editorPanel = await fixture(html`<editor-panel></editor-panel>`, { parentNode: spTheme });
                        // Mock the repository methods
                        editorPanel.repository.aem.sites.cf.fragments.getVersions = async () => ({ items: [] });
                        editorPanel.repository.refreshFragment = async () => {};
                        editorPanel.repository.getFragment = async () => mockFragment;
                        editorPanel.repository.aem.getFragmentById = async () => mockFragment;
                        await editorPanel.editFragment(fragmentStore);
                        await editorPanel.updateComplete;
                        const store = Store.fragments.inEdit.get();
                        if (store) {
                            const frag = store.get();
                            if (frag) {
                                frag.initialValue = structuredClone(frag);
                                frag.hasChanges = false;
                            }
                            store.notify();
                        }
                        await editorPanel.updateComplete;
                    });

                    it('renders editor panel for collection fragments', async () => {
                        // Verify that the editor panel renders the collection editor
                        const editorContent = editorPanel.querySelector('merch-card-collection-editor');
                        expect(editorContent).to.exist;
                    });

                    it('displays version history button in toolbar', async () => {
                        await editorPanel.editFragment(fragmentStore);
                        await editorPanel.updateComplete;
                        await delay(100);

                        const versionHistory = document.querySelector('version-history');
                        expect(versionHistory).to.exist;
                        expect(versionHistory.versions).to.deep.equal(editorPanel.fragmentVersions);
                        expect(versionHistory.selectedVersion).to.equal(editorPanel.selectedVersion);
                    });

                    it('loads fragment versions when editing a fragment', async () => {
                        // Mock the getFragmentVersions method
                        const mockVersions = {
                            items: [
                                { id: 'version1', version: '1.0', created: '2023-01-01T00:00:00Z' },
                                { id: 'version2', version: '2.0', created: '2023-01-02T00:00:00Z' },
                            ],
                        };

                        // Get the repository and create stub before editing fragment
                        const repository = editorPanel.repository;
                        const originalGetVersions = repository.aem.sites.cf.fragments.getVersions;

                        // Create a promise-based stub
                        repository.aem.sites.cf.fragments.getVersions = async function (fragmentId, options) {
                            // Verify the function is called with the correct fragment ID
                            expect(fragmentId).to.equal('12345678-1234-1234-1234-123456789012');
                            return mockVersions;
                        };

                        // The editor panel was already initialized with a fragment in beforeEach
                        // so it should already have versions loaded. Let's just verify the version history component exists
                        await editorPanel.updateComplete;
                        await delay(500);

                        // Check that versions were loaded (from beforeEach)
                        const versionHistory = document.querySelector('version-history');
                        expect(versionHistory).to.exist;

                        // Restore original method
                        repository.aem.sites.cf.fragments.getVersions = originalGetVersions;
                    });
                });
            });
        </script>
        <mas-repository base-url="http://localhost:2023/test/mocks"></mas-repository>
        <sp-theme system="spectrum-two" color="light" scale="medium"></sp-theme>
    </body>
</html>
