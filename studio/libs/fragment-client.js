var e,t,r,a="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},s={exports:{}};e=s,t=s.exports,r=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==a)return a;throw new Error("unable to locate global object")}(),e.exports=t=r.fetch,r.fetch&&(t.default=r.fetch.bind(r)),t.Headers=r.Headers,t.Request=r.Request,t.Response=r.Response;var n=s.exports;const l=["cards","collections","entries"],o=[...l,"tags"];function i(e){const{fields:t,references:r}=e,a={};r&&r.forEach((e=>{const{type:t,path:r,id:s}=e;"content-fragment"===t&&(a[r]=s)}));const s=t.reduce(((e,{name:t,multiple:r,values:s,mimeType:n})=>(l.includes(t)?e[t]=s.map((e=>"string"==typeof e&&a[e]||e)):e[t]="text/html"===n?{mimeType:n,value:s[0]}:r?s:s[0],e)),{});return s}function c(e,t){if(!e)return[];const r=[];for(const[a,s]of Object.entries(e))o.includes(a)&&Array.isArray(s)&&s.forEach((e=>{if(t[e]){const s={fieldName:a,identifier:e,referencesTree:[]},n=t[e];"content-fragment"===n.type&&(s.referencesTree=c(n.value.fields,t)),r.push(s)}}));return r}function u(e){if(!e.references)return e;const t=(e,r)=>{const a=i(r);r.references&&r.references.length>0&&r.references.forEach((r=>{Object.keys(e).find((e=>e===r.id))||t(e,r)})),e[r.id]={type:r.type,value:{name:r.name||"",title:r.title||"",description:r.description||"",path:r.path||"",id:r.id,model:{id:r.model?.id},fields:a}},r.tags&&Array.isArray(r.tags)&&r.tags.forEach((t=>{t&&t.id&&!e[t.id]&&(e[t.id]={type:"tag",value:{id:t.id,name:t.name||"",title:t.title||"",path:t.path||"",description:void 0!==t.description?t.description:null,i18n:t.i18n||[],titlePath:t.titlePath||""}})}))};return e.references&&(e.references=e.references.reduce(((e,r)=>(t(e,r),e)),{}),e.referencesTree=c(e.fields,e.references)),e}var d={transformBody:function(e){return e.fields=i(e),e=u(e)}};const f=n,{transformBody:p}=d;function h(e,t="info"){return`[${t}][${e.api_key}][${e.requestId}][${e.transformer}]`}function y(e,t){console.log(`${h(t)} ${e}`)}function b(e,t){console.error(`${h(t,"error")} ${e}`)}function g(e,t){t.debugLogs&&console.log(`${h(t,"debug")} ${e()}`)}async function m(e){let t="nok";try{const r=await e.json();t=r?.detail}catch(e){}return t}async function x(e,t){let r=await e.json();return t.preview&&Array.isArray(r.fields)&&(y("massaging old school schema for preview",t),r=p(r)),r}var v={fetch:async function(e,t){try{const r=Date.now(),a=await f(e,{headers:t.DEFAULT_HEADERS}),s=200==a.status,n=s?"ok":await m(a);return y(`fetch ${e} (${a?.status}) ${n} in ${Date.now()-r}ms`,t),g((()=>`response headers: ${JSON.stringify(Object.fromEntries(a.headers.entries()))}`),t),200===a.status?{status:200,body:await x(a,t)}:a}catch(r){b(`[fetch] ${e} fetch error: ${r.message}`,t)}return{...t,status:500,message:"fetch error"}},getErrorContext:async function(e){return{status:e.status,message:await m(e)}},log:y,logDebug:g,logError:b};const{logDebug:w}=v;var T=async function(e){const{priceLiterals:t}=e.body;for(const[r,a]of Object.entries(t))"string"==typeof a&&/^price-literal-/.test(a)&&(w((()=>`no placeholder has been authored for ${r}`),e),delete e.body.priceLiterals[r]);return e};const $="/content/dam/mas",L="https://odin.adobe.com/adobe/sites/fragments";function E(e){return`${e?.url?e.url:L}`}function R(e,t){return`${E(t)}/${e}`}var A={PATH_TOKENS:/\/content\/dam\/mas\/(?<surface>[\w-_]+)\/(?<parsedLocale>[\w-_]+)\/(?<fragmentPath>.+)/,FRAGMENT_URL_PREFIX:L,MAS_ROOT:$,odinPath:function(e,t,r,a){return`${E(a)}?path=${$}/${e}/${t}/${r}`},odinId:R,odinReferences:function(e,t=!1,r){return`${R(e,r)}${t?"?references=all-hydrated":""}`}};const{fetch:P,getErrorContext:O}=v,{odinReferences:_}=A;var k=async function(e){const{id:t,locale:r,translatedId:a,preview:s}=e;if(t&&r){const r=_(a||t,!0,s),n=await P(r,e);return 200==n.status?{...e,body:n.body}:O(n)}return{...e,status:400,message:"requested parameters are not present"}};const{odinReferences:S,odinPath:j}=A,{fetch:N,log:I,logDebug:D,logError:F}=v,M=/{{(\s*([\w\-\_]+)\s*)}}/gi;async function U(e){const t=e.dictionary||{},r=e.dictionaryId??await async function(e){const{surface:t,locale:r,preview:a}=e,s=j(t,r,"dictionary/index",a),n=await N(s,e);if(200==n.status){const{items:t}=n.body;if(t?.length>0){const r=t[0].id;return e.dictionaryId=r,r}}return null}(e);if(!r)return t;const a=await N(S(r,!0,e.preview),e);if(200==a.status){const e=a.body.references;return Object.keys(e).forEach((r=>{const a=e[r]?.value?.fields;a?.key&&(t[a.key]=function(e){return(e.value||e.richTextValue?.value||"").replace(/[\u0000-\u001F\u007F-\u009F]/g,"").replace(/"/g,'\\"')}(a))})),t}return t}function H(e,t,r){const a=e.matchAll(M);let s="",n=0;for(const l of a){const a=l[1];s+=e.slice(n,l.index);let o=null==t[a]||r.includes(a)?a:t[a];o?.match(M)&&(r.push(a),o=H(o,t,r),r.pop()),s+=o,n=l.index+l[0].length}return s+=e.slice(n),s}var q=async function(e){let t=e.body,r=JSON.stringify(t);if(r.match(M)){const a=await U(e);if(a&&Object.keys(a).length>0){r=H(r,a,[]);try{t=JSON.parse(r)}catch(t){F(`[replace] ${t.message}`,e),D((()=>`[replace] invalid json: ${r}`),e)}}}else I("no placeholders found in fragment content",e);return{...e,status:200,body:t}};function W(e){e.body?.references&&Object.entries(e.body.references).forEach((([t,r])=>{if(r&&"content-fragment"===r.type){const t=r.value?.fields?.variant;t?.startsWith("plans")&&z(r.value,e),"mini"===t&&C(r.value,e)}})),e.body.placeholders={searchText:"{{coll-search-text}}",filtersText:"{{coll-filters-text}}",sortText:"{{coll-sort-text}}",popularityText:"{{coll-popularity-text}}",alphabeticallyText:"{{coll-alphabetically-text}}",noResultsText:"{{coll-no-results-text}}",plansSidenavTitle:"{{coll-plans-sidenav-title}}",resultText:"{{coll-result-text}}",resultsText:"{{coll-results-text}}",resultMobileText:"{{coll-result-mobile-text}}",resultsMobileText:"{{coll-results-mobile-text}}",searchResultText:"{{coll-search-result-text}}",searchResultsText:"{{coll-search-results-text}}",searchResultMobileText:"{{coll-search-result-mobile-text}}",searchResultsMobileText:"{{coll-search-results-mobile-text}}",noSearchResultsText:"{{coll-no-search-results-text}}",showMoreText:"{{coll-show-more-text}}"},e.dictionary={...e?.dictionary,"coll-filter":'<span data-placeholder=\\"filter\\"></span>',"coll-result-count":'<span data-placeholder=\\"resultCount\\"></span>',"coll-search-term":'<span data-placeholder=\\"searchTerm\\"></span>'}}function z(e,t){const{locale:r}=t;e.settings={},!1!==e?.fields?.showSecureLabel&&(e.settings.secureLabel="{{secure-label}}"),null!=e?.fields?.showPlanType&&(e.settings.displayPlanType=e?.fields?.showPlanType),"en_US"===r&&(e.settings.displayPlanType??=!0)}function C(e,t){const{locale:r}=t;"en_AU"===r&&(e.settings={displayPlanType:!0})}var J=async function(e){var t;return e.body?.fields?.variant?.startsWith("plans")&&z(e.body,e),"mini"===e.body?.fields?.variant&&C(e.body,e),"L2NvbmYvbWFzL3NldHRpbmdzL2RhbS9jZm0vbW9kZWxzL2NvbGxlY3Rpb24"===e.body?.model?.id&&W(e),(t=e.body)&&(t.priceLiterals={recurrenceLabel:"{{price-literal-recurrence-label}}",recurrenceAriaLabel:"{{price-literal-recurrence-aria-label}}",perUnitLabel:"{{price-literal-per-unit-label}}",perUnitAriaLabel:"{{price-literal-per-unit-aria-label}}",freeLabel:"{{price-literal-free-label}}",freeAriaLabel:"{{price-literal-free-aria-label}}",taxExclusiveLabel:"{{price-literal-tax-exclusive-label}}",taxInclusiveLabel:"{{price-literal-tax-inclusive-label}}",alternativePriceAriaLabel:"{{price-literal-alternative-price-aria-label}}",strikethroughAriaLabel:"{{price-literal-strikethrough-aria-label}}",planTypeLabel:"{{price-literal-plan-type-label}}"}),e};const{PATH_TOKENS:B,odinPath:G,odinReferences:K}=A,{fetch:Y,log:Z}=v;var V=async function(e){const{body:t,locale:r,preview:a}=e;let s;const n=t?.path?.match(B);if(!n)return{status:400,message:"source path is either not here or invalid"};const{surface:l,parsedLocale:o,fragmentPath:i}=n.groups;if(r&&o!==r){const t=G(l,r,i,a),n=await Y(t,e);if(200!=n.status)return{status:500,message:"translation search failed"};const{items:[{id:o}={}]}=n.body;if(!o)return{status:404,message:"no translation found"};{const t=K(o,!0,a),r=await Y(t,e);if(200!=r.status)return{status:500,message:"translation search failed"};s=r.body,e.translatedId=o}}else Z("no translation needed",e);return{...e,status:200,body:s||t,surface:l,parsedLocale:o,fragmentPath:i}};async function X(e,t){const{locale:r="en_US",preview:a={url:"https://odinpreview.corp.adobe.com/adobe/sites/cf/fragments"}}=t;let s={id:e,status:200,preview:a,requestId:"preview",api_key:"n/a",locale:r};for(const e of[k,V,J,q,T]){if(200!=s.status){v.logError(s.message,s);break}s.transformer=e.name,s=await e(s)}return 200!=s.status&&v.logError(s.message,s),s.body}export{X as previewFragment};
//# sourceMappingURL=fragment-client.js.map
