var e,t,n,r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},s={exports:{}};e=s,t=s.exports,n=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==r)return r;throw new Error("unable to locate global object")}(),e.exports=t=n.fetch,n.fetch&&(t.default=n.fetch.bind(n)),t.Headers=n.Headers,t.Request=n.Request,t.Response=n.Response;var a=s.exports;const o=["cards","collections","entries"],i=[...o,"tags"];function c(e){const{fields:t,references:n}=e,r={};n&&n.forEach((e=>{const{type:t,path:n,id:s}=e;"content-fragment"===t&&(r[n]=s)}));const s=t.reduce(((e,{name:t,multiple:n,values:s,mimeType:a})=>(o.includes(t)?e[t]=s.map((e=>"string"==typeof e&&r[e]||e)):e[t]="text/html"===a?{mimeType:a,value:s[0]}:n?s:s[0],e)),{});return s}function f(e,t){if(!e)return[];const n=[];for(const[r,s]of Object.entries(e))i.includes(r)&&Array.isArray(s)&&s.forEach((e=>{if(t[e]){const s={fieldName:r,identifier:e,referencesTree:[]},a=t[e];"content-fragment"===a.type&&(s.referencesTree=f(a.value.fields,t)),n.push(s)}}));return n}function l(e){if(!e.references)return e;const t=(e,n)=>{const r=c(n);n.references&&n.references.length>0&&n.references.forEach((n=>{Object.keys(e).find((e=>e===n.id))||t(e,n)})),e[n.id]={type:n.type,value:{name:n.name||"",title:n.title||"",description:n.description||"",path:n.path||"",id:n.id,model:{id:n.model?.id},fields:r}},n.tags&&Array.isArray(n.tags)&&n.tags.forEach((t=>{t&&t.id&&!e[t.id]&&(e[t.id]={type:"tag",value:{id:t.id,name:t.name||"",title:t.title||"",path:t.path||"",description:void 0!==t.description?t.description:null,i18n:t.i18n||[],titlePath:t.titlePath||""}})}))};return e.references&&(e.references=e.references.reduce(((e,n)=>(t(e,n),e)),{}),e.referencesTree=f(e.fields,e.references)),e}var u={transformBody:function(e){return e.fields=c(e),e=l(e)}};const d=a,{transformBody:p}=u;function y(e,t="info"){return`[${t}][${e.api_key}][${e.requestId}][${e.transformer}]`}function h(e,t){console.log(`${y(t)} ${e}`)}function g(e,t){console.error(`${y(t,"error")} ${e}`)}function m(e,t){t.debugLogs&&console.log(`${y(t,"debug")} ${e()}`)}async function b(e){let t="nok";try{const n=await e.json();t=n?.detail}catch(e){}return t}async function w(e,t){let n=await e.json();return t.preview&&Array.isArray(n.fields)&&(h("massaging old school schema for preview",t),n=p(n)),n}var v={fetch:async function(e,t){try{const n=Date.now(),r=await d(e,{headers:t.DEFAULT_HEADERS}),s=200==r.status,a=s?"ok":await b(r);return h(`fetch ${e} (${r?.status}) ${a} in ${Date.now()-n}ms`,t),m((()=>`response headers: ${JSON.stringify(Object.fromEntries(r.headers.entries()))}`),t),200===r.status?{status:200,body:await w(r,t)}:r}catch(n){g(`[fetch] ${e} fetch error: ${n.message}`,t)}return{...t,status:500,message:"fetch error"}},getErrorContext:async function(e){return{status:e.status,message:await b(e)}},log:h,logDebug:m,logError:g};const $="/content/dam/mas",E="https://odin.adobe.com/adobe/sites/fragments";function T(e){return`${e?.url?e.url:E}`}function k(e,t){return`${T(t)}/${e}`}var O={PATH_TOKENS:/\/content\/dam\/mas\/(?<surface>[\w-_]+)\/(?<parsedLocale>[\w-_]+)\/(?<fragmentPath>.+)/,FRAGMENT_URL_PREFIX:E,MAS_ROOT:$,odinPath:function(e,t,n,r){return`${T(r)}?path=${$}/${e}/${t}/${n}`},odinId:k,odinReferences:function(e,t=!1,n){return`${k(e,n)}${t?"?references=all-hydrated":""}`}};const{fetch:P,getErrorContext:x}=v,{odinReferences:A}=O;var R=async function(e){const{id:t,locale:n,translatedId:r,preview:s}=e;if(t&&n){const n=A(r||t,!0,s),a=await P(n,e);return 200==a.status?{...e,body:a.body}:x(a)}return{...e,status:400,message:"requested parameters are not present"}};const{PATH_TOKENS:_,odinPath:S,odinReferences:j}=O,{fetch:L,log:I}=v;var N=async function(e){const{body:t,locale:n,preview:r}=e;let s;const a=t?.path?.match(_);if(!a)return{status:400,message:"source path is either not here or invalid"};const{surface:o,parsedLocale:i,fragmentPath:c}=a.groups;if(n&&i!==n){const t=S(o,n,c,r),a=await L(t,e);if(200!=a.status)return{status:500,message:"translation search failed"};const{items:[{id:i}={}]}=a.body;if(!i)return{status:404,message:"no translation found"};{const t=j(i,!0,r),n=await L(t,e);if(200!=n.status)return{status:500,message:"translation search failed"};s=n.body,e.translatedId=i}}else I("no translation needed",e);return{...e,status:200,body:s||t,surface:o,parsedLocale:i,fragmentPath:c}};const{odinReferences:F,odinPath:q}=O,{fetch:D,log:H,logError:U}=v,C=/{{(\s*([\w\-]+)\s*)}}/gi;async function J(e){const t=e.dictionaryId??await async function(e){const{surface:t,locale:n,preview:r}=e,s=q(t,n,"dictionary/index",r),a=await D(s,e);if(200==a.status){const{items:t}=a.body;if(t?.length>0){const n=t[0].id;return e.dictionaryId=n,n}}return null}(e);if(!t)return null;const n=await D(F(t,!0,e.preview),e);if(200==n.status){const e=n.body.references,t={};return Object.keys(e).forEach((n=>{const r=e[n]?.value?.fields;r?.key&&(t[r.key]=function(e){return(e.value||e.richTextValue?.value||"").replace(/[\u0000-\u001F\u007F-\u009F]/g,"").replace(/"/g,'\\"')}(r))})),t}return null}function B(e,t,n){const r=e.matchAll(C);let s="",a=0;for(const o of r){const r=o[1];s+=e.slice(a,o.index);let i=null==t[r]||n.includes(r)?r:t[r];i.match(C)&&(n.push(r),i=B(i,t,n),n.pop()),s+=i,a=o.index+o[0].length}return s+=e.slice(a),s}var K=async function(e){let t=e.body,n=JSON.stringify(t);if(n.match(C)){const r=await J(e);if(r&&Object.keys(r).length>0){n=B(n,r,[]);try{t=JSON.parse(n)}catch(t){U(`[replace] ${t.message}`,e)}}}else H("no placeholders found in fragment content",e);return{...e,status:200,body:t}};function M(e,t){e.settings={stockCheckboxLabel:"{{stock-checkbox-label}}",stockOfferOsis:""},!1!==e?.fields?.showSecureLabel&&(e.settings.secureLabel="{{secure-label}}"),null!=e?.fields?.showPlanType&&(e.settings.displayPlanType=e?.fields?.showPlanType),"en_US"===t&&(e.settings.displayPlanType??=!0)}var W=async function(e){const{locale:t}=e;return e.body?.fields?.variant?.startsWith("plans")&&M(e.body,t),e.body?.references&&Object.entries(e.body.references).forEach((([e,n])=>{n&&"content-fragment"===n.type&&n.value?.fields?.variant?.startsWith("plans")&&M(n.value,t)})),e};async function G(e,t){const{locale:n="en_US",preview:r={url:"https://odinpreview.corp.adobe.com/adobe/sites/cf/fragments"}}=t;let s={id:e,status:200,preview:r,requestId:"preview",api_key:"n/a",locale:n};for(const e of[R,N,W,K]){if(200!=s.status){v.logError(s.message,s);break}s.transformer=e.name,s=await e(s)}return 200!=s.status&&v.logError(s.message,s),s.body}export{G as previewFragment};
//# sourceMappingURL=fragment-client.js.map
